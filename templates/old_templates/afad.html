<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFAD Arama Kurtarma YÃ¶netim Paneli</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta8fBh2P+PtF6ovYdxcW2wNsBkjV8g0pBwIasSgK+bQ=" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Genel Stil */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.4;
            /* KÃ¼Ã§Ã¼k ekranlarda varsayÄ±lan: dikey dÃ¼zen, kaydÄ±rÄ±labilir */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Yatay kaydÄ±rmayÄ± engelle */
            overflow-y: auto; /* Dikey kaydÄ±rmaya izin ver */
        }

        .main-wrapper {
            display: flex;
            flex-grow: 1; /* Ana wrapper'Ä±n tÃ¼m boÅŸ alanÄ± kaplamasÄ±nÄ± saÄŸlar */
            flex-direction: column; /* KÃ¼Ã§Ã¼k ekranlarda dikey */
        }

        .container {
            max-width: 480px;
            width: 100%; /* Mobil uyumluluk */
            margin: 0 auto;
            background: white;
            /* min-height: 100vh; Harita ile birlikte tÃ¼m ekranÄ± kaplasÄ±n */ /* KaldÄ±rÄ±ldÄ± */
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            order: 2; /* KÃ¼Ã§Ã¼k ekranlarda haritanÄ±n altÄ±nda gÃ¶rÃ¼nsÃ¼n */
            display: flex; /* Ä°Ã§eriÄŸi kendi iÃ§inde flexbox yap */
            flex-direction: column;
            /* Ä°Ã§erik uzadÄ±kÃ§a kendi iÃ§inde kaydÄ±rÄ±labilir olmalÄ±, navbar ve header sabit kalmalÄ± */
            height: auto; /* Otomatik yÃ¼kseklik */
        }
        
        .data-cards {
            flex-grow: 1; /* Data kartlarÄ±nÄ±n kalan alanÄ± doldurmasÄ±nÄ± saÄŸlar */
            overflow-y: auto; /* Ä°Ã§erik taÅŸarsa kaydÄ±rÄ±labilir olsun */
            -webkit-overflow-scrolling: touch; /* iOS iÃ§in yumuÅŸak kaydÄ±rma */
            padding-bottom: 70px; /* Refresh butonu iÃ§in boÅŸluk */
        }


        /* Yeni: Ana Harita Konteyneri */
        #mainMapContainer {
            flex-grow: 1; /* Harita konteynerÄ±nÄ±n boÅŸ alanÄ± kaplamasÄ±nÄ± saÄŸlar */
            order: 1; /* KÃ¼Ã§Ã¼k ekranlarda haritanÄ±n Ã¼stÃ¼nde gÃ¶rÃ¼nsÃ¼n */
            height: 300px; /* Mobil cihazlar iÃ§in varsayÄ±lan harita yÃ¼ksekliÄŸi */
            width: 100%;
            position: relative; /* Ä°Ã§indeki harita iÃ§in */
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            z-index: 1; /* Konteynerin diÄŸer elemanlarÄ±n Ã¼stÃ¼nde veya altÄ±nda kalmasÄ±nÄ± ayarlar */
            background-color: #e0e0e0; /* YÃ¼klenirken veya boÅŸken gri arka plan */
        }

        #mainMap {
            height: 100%;
            width: 100%;
            border-radius: 0px; /* KÃ¶ÅŸeleri yuvarlamayÄ± kaldÄ±rabiliriz */
        }

        /* Responsive TasarÄ±m: BÃ¼yÃ¼k ekranlarda harita ve liste yan yana */
        @media (min-width: 900px) { /* Tablet ve Ã¼zeri ekranlar iÃ§in */
            body {
                flex-direction: row; /* Yan yana hizala */
                height: 100vh; /* Tam ekran yÃ¼ksekliÄŸi */
                overflow: hidden; /* KaydÄ±rmayÄ± engelle */
            }
            .main-wrapper {
                flex-direction: row;
                height: 100%; /* Ana wrapper'Ä±n tÃ¼m yÃ¼ksekliÄŸi kaplamasÄ±nÄ± saÄŸlar */
            }
            #mainMapContainer {
                order: 1;
                width: calc(100% - 480px); /* Kalan alanÄ± kapla */
                height: 100vh; /* Tam ekran yÃ¼ksekliÄŸi */
            }
            .container {
                order: 2;
                max-width: 480px; /* Sabit geniÅŸlik */
                height: 100vh; /* Tam ekran yÃ¼ksekliÄŸi */
                min-height: unset; /* Override previous min-height */
                overflow-y: hidden; /* Harita ve liste yan yana olduÄŸunda konteynerin kaydÄ±rmasÄ±nÄ± engelle */
            }
            /* Harita ve liste yan yana olduÄŸunda, sadece data-cards kÄ±smÄ± kaydÄ±rÄ±labilir olmalÄ± */
            .data-cards {
                flex-grow: 1;
                overflow-y: auto; /* Ä°Ã§erik taÅŸarsa kaydÄ±rÄ±labilir olsun */
                -webkit-overflow-scrolling: touch;
                padding-bottom: 20px; /* Refresh butonu altta olduÄŸu iÃ§in boÅŸluk bÄ±rakma */
            }
        }


        /* Header */
        .header {
            background: linear-gradient(135deg, #3b82f6, #2563eb); /* AFAD iÃ§in mavi tonlarÄ± */
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Status Bar */
        .status-bar {
            background: #f1f5f9;
            padding: 10px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444; /* KÄ±rmÄ±zÄ± - baÄŸlantÄ± yok */
        }

        .status-dot.connected {
            background: #22c55e; /* YeÅŸil - baÄŸlantÄ± var */
        }

        /* Data Cards */
        /* padding moved to .data-cards rule above */

        .data-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6; /* VarsayÄ±lan mavi */
            border: 2px solid #e5e7eb;
            position: relative;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        /* Ã–ncelik Renkleri */
        .data-card.priority-high {
            border-left-color: #dc2626; /* KÄ±rmÄ±zÄ± */
            border-color: #fecaca;
            background: #fef2f2;
        }

        .data-card.priority-medium {
            border-left-color: #f59e0b; /* Turuncu */
            border-color: #fed7aa;
            background: #fffbeb;
        }

        .data-card.priority-low {
            border-left-color: #10b981; /* YeÅŸil */
            border-color: #a7f3d0;
            background: #f0fdf4;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-id {
            font-weight: 600;
            font-size: 16px;
            color: #374151;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: flex; /* Ä°konu yanÄ±na almak iÃ§in */
            align-items: center;
            gap: 4px; /* Ä°kon ile metin arasÄ±na boÅŸluk */
        }
        .priority-badge .ai-icon { /* AI ikonu iÃ§in stil */
            font-size: 12px; /* Ä°kon boyutu */
            opacity: 0.7; /* Hafif transparan */
            color: white; /* Ä°kon rengi */
        }


        .priority-high { background: #dc2626; color: white; }
        .priority-medium { background: #f59e0b; color: white; }
        .priority-low { background: #10b981; color: white; }

        .card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        
        .info-value.bold {
            font-weight: 600;
        }

        .location-info {
            grid-column: 1 / -1;
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        /* Yeni: Konum bilgisine tÄ±klanabilirlik iÃ§in cursor */
        .location-info .info-value.clickable {
            cursor: pointer;
            text-decoration: underline;
            color: #3b82f6; /* Link rengi */
        }
        .location-info .info-value.clickable:hover {
            color: #2563eb;
        }


        .current-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.05);
            padding: 12px;
            border-radius: 8px;
        }

        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.8);
        }

        /* DÃœZELTME: Bekleniyor durumu iÃ§in gri renk */
        .status-bekleniyor { 
            background: #94a3b8; /* Gri */
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.2);
        }
        .status-mudahale { 
            background: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .status-kurtarildi { 
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .status-text {
            font-weight: 700;
            font-size: 16px;
            color: #1f2937;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* DÃœZELTME: Bekleniyor durumu metin rengi */
        .status-bekleniyor + .status-text { color: #475569; } /* Koyu gri */
        .status-mudahale + .status-text { color: #1e40af; }
        .status-kurtarildi + .status-text { color: #047857; }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-bekleniyor {
            background: #fbbf24;
            color: white;
        }

        .btn-mudahale {
            background: #3b82f6;
            color: white;
        }

        .btn-kurtarildi {
            background: #10b981;
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Mini map kaldÄ±rÄ±ldÄ±, ilgili CSS'i yorum satÄ±rÄ± yapabiliriz */
        /*
        .mini-map {
            height: 150px;
            border-radius: 8px;
            margin-top: 10px;
            overflow: hidden;
        }
        */

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #3b82f6; /* AFAD iÃ§in mavi */
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            z-index: 999; /* Refresh butonu diÄŸer Ã¶ÄŸelerin Ã¼stÃ¼nde olsun */
        }

        .refresh-btn:hover {
            transform: scale(1.1);
        }

        .refresh-btn.loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .timestamp {
            font-size: 11px;
            color: #9ca3af;
            text-align: right;
            margin-top: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc2626;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .data-cards {
                padding: 15px;
            }
        }

        .data-card.removing {
            animation: slideOut 0.5s ease-in-out forwards;
            pointer-events: none;
        }

        @keyframes slideOut {
            0% {
                opacity: 1;
                transform: translateX(0);
                max-height: 500px;
                margin-bottom: 15px;
            }
            50% {
                opacity: 0.5;
                transform: translateX(100%);
                max-height: 500px;
                margin-bottom: 15px;
            }
            100% {
                opacity: 0;
                transform: translateX(100%);
                max-height: 0;
                margin-bottom: 0;
                padding: 0;
            }
        }

        .data-card.rescued {
            background: linear-gradient(135deg, #10b981, #059669);
            border-left-color: #10b981;
            color: white;
            animation: successPulse 0.3s ease-in-out;
        }

        .data-card.rescued .info-label,
        .data-card.rescued .info-value,
        .data-card.rescued .card-id,
        .data-card.rescued .status-text {
            color: white;
        }

        .data-card.rescued .priority-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Navbar for logged-in users */
        .navbar {
            background: #2563eb; /* Koyu mavi */
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s ease;
        }
        .navbar a:hover {
            background: rgba(255,255,255,0.1);
        }
        .navbar .user-info {
            font-weight: 600;
        }
        .navbar .user-info .role {
            font-size: 11px;
            opacity: 0.8;
            margin-left: 5px;
        }

        /* Flash Messages */
        .flash-message {
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 0px; /* Header'a yapÄ±ÅŸÄ±k dursun */
        }
        .flash-message.success {
            background-color: #dcfce7;
            color: #166534;
        }
        .flash-message.danger {
            background-color: #fef2f2;
            color: #991b1b;
        }
        .flash-message.info {
            background-color: #dbeafe;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div id="mainMapContainer">
            <div id="mainMap"></div>
        </div>

        <div class="container">
            <div class="navbar">
                <div class="user-info">
                    {% if current_user.is_authenticated %}
                        Merhaba, {{ current_user.username }}! <span class="role">({% if current_user.role == 'admin' %}YÃ¶netici{% else %}GÃ¶revli{% endif %})</span>
                    {% else %}
                        Misafir
                    {% endif %}
                </div>
                <div>
                    {% if current_user.is_authenticated %}
                        {% if current_user.role == 'admin' %}
                            <a href="{{ url_for('admin_panel_page') }}">Admin Paneli</a>
                        {% endif %}
                        <a href="{{ url_for('logout') }}">Ã‡Ä±kÄ±ÅŸ Yap</a>
                    {% else %}
                        <a href="{{ url_for('login_page') }}">GiriÅŸ Yap</a>
                    {% endif %}
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <ul class="list-none p-0 m-0">
                    {% for category, message in messages %}
                        <li class="flash-message {{ category }}">{{ message }}</li>
                    {% endfor %}
                    </ul>
                {% endif %}
            {% endwith %}

            <div class="header">
                <h1>âš™ï¸ AFAD YÃ¶netim Paneli</h1>
                <div class="subtitle">Arama Kurtarma OperasyonlarÄ±</div>
            </div>

            <div class="status-bar">
                <div class="connection-status">
                    <div class="status-dot" id="connectionDot"></div>
                    <span id="connectionText">BaÄŸlantÄ± kontrol ediliyor...</span>
                </div>
                <div id="lastUpdate">--:--</div>
            </div>

            <div class="data-cards" id="dataCards">
            </div>

            <div class="empty-state" id="emptyState" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</div>
                <h3>HenÃ¼z aktif gÃ¶rev bulunmuyor</h3>
                <p>Yeni yardÄ±m Ã§aÄŸrÄ±larÄ± bekleniyor...</p>
            </div>
        </div>
    </div>

    <button class="refresh-btn" id="refreshBtn" onclick="fetchData()">
        ğŸ”„
    </button>

    <div class="notification" id="notification"></div>

    <script>
        let mockData = [];
        let lastDataHash = '';

        let isConnected = false;
        let dataCards = document.getElementById('dataCards');
        let emptyState = document.getElementById('emptyState');
        let connectionDot = document.getElementById('connectionDot');
        let connectionText = document.getElementById('connectionText');
        let lastUpdate = document.getElementById('lastUpdate');
        let refreshBtn = document.getElementById('refreshBtn');

        let mainMap; // Ana harita objesi
        let mainMapMarkers = L.featureGroup(); // Ana harita Ã¼zerindeki tÃ¼m markerlar iÃ§in katman grubu

        // BaÄŸlantÄ± durumunu gÃ¼ncelle
        function updateConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                connectionDot.classList.add('connected');
                connectionText.textContent = 'Sistem baÄŸlÄ±';
            } else {
                connectionDot.classList.remove('connected');
                connectionText.textContent = 'BaÄŸlantÄ± kesildi';
            }
        }

        // Bildirim gÃ¶ster
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Durum Ã§evirici
        function getStatusText(durum) {
            const statusMap = {
                'bekleniyor': 'Bekliyor',
                'mudahale': 'MÃ¼dahale Ediliyor',
                'kurtarildi': 'KurtarÄ±ldÄ±'
            };
            return statusMap[durum] || durum;
        }

        // Ã–ncelik Ã§evirici
        function getPriorityText(oncelik) {
            const priorityMap = {
                'high': 'Acil',
                'medium': 'Orta',
                'low': 'DÃ¼ÅŸÃ¼k'
            };
            return priorityMap[oncelik] || oncelik;
        }

        // Zaman formatÄ±
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Tarih formatÄ±
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', { 
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Durum gÃ¼ncelleme
        async function updateStatus(id, newStatus) {
            try {
                showNotification('Durum gÃ¼ncelleniyor...');
                
                const response = await fetch('/api/durum-guncelle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        durum: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    lastDataHash = calculateDataHash(result.data);
                    mockData = result.data;
                    
                    if (newStatus === 'kurtarildi') {
                        const cardElement = document.querySelector(`[data-id="${id}"]`);
                        if (cardElement) {
                            cardElement.classList.add('rescued');
                            showNotification('âœ… Kurtarma tamamlandÄ±!');
                            
                            setTimeout(() => {
                                cardElement.classList.add('removing');
                                
                                setTimeout(() => {
                                    mockData = mockData.filter(item => item.id !== id);
                                    renderData(); // Veri listesi ve haritayÄ± yenile
                                }, 500);
                            }, 1500);
                        }
                    } else {
                        renderData(); // Veri listesi ve haritayÄ± yenile
                        showNotification(result.message);
                    }
                    
                } else {
                    showNotification(result.message, true);
                }
                
            } catch (error) {
                showNotification('Durum gÃ¼ncellenirken hata oluÅŸtu: ' + error.message, true);
            }
        }

        // Mini harita oluÅŸturma fonksiyonu kaldÄ±rÄ±ldÄ±

        // Ã–ncelik sÄ±ralamasÄ± iÃ§in yardÄ±mcÄ± fonksiyon
        function getPriorityOrder(priority) {
            const order = { 'high': 1, 'medium': 2, 'low': 3 };
            return order[priority] || 4;
        }

        // Ana Harita FonksiyonlarÄ±
        function initMainMap() {
            if (mainMap) {
                mainMap.remove(); // Ã–nceki harita Ã¶rneÄŸini kaldÄ±r
            }
            // Bursa'nÄ±n merkez koordinatlarÄ±
            const defaultLat = 40.1885;
            const defaultLng = 29.0609;
            mainMap = L.map('mainMap').setView([defaultLat, defaultLng], 7); // TÃ¼rkiye veya varsayÄ±lan bir merkeze odaklanma
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(mainMap);

            mainMapMarkers.addTo(mainMap); // Marker grubunu haritaya ekle
        }

        function updateMainMapMarkers() {
            mainMapMarkers.clearLayers(); // TÃ¼m eski markerlarÄ± temizle

            if (!mockData || mockData.length === 0) {
                return; // Veri yoksa marker ekleme
            }

            let bounds = L.latLngBounds([]); // TÃ¼m markerlarÄ± kapsayacak sÄ±nÄ±rlar iÃ§in

            mockData.forEach(item => { // TÃ¼m aktif talepleri haritada gÃ¶ster
                let markerColor;
                // YENÄ° DÃœZELTME: Renk mantÄ±ÄŸÄ± - Ã–ncelik rengi, durum rengini baskÄ±n kÄ±lacak
                if (item.oncelik === 'high') {
                    markerColor = '#dc2626'; // KÄ±rmÄ±zÄ± (Acil)
                } else if (item.oncelik === 'medium') {
                    markerColor = '#f59e0b'; // Turuncu (Orta)
                } else if (item.oncelik === 'low') {
                    markerColor = '#10b981'; // YeÅŸil (DÃ¼ÅŸÃ¼k)
                } else {
                    markerColor = '#94a3b8'; // VarsayÄ±lan/Gri (Bekleniyor ile benzer)
                }
                
                // Duruma gÃ¶re renk Ã¼zerinde ufak bir oynama yapabiliriz (opsiyonel, ÅŸimdilik sadece ana Ã¶ncelik rengi)
                // Ã–rneÄŸin, mÃ¼dahale ediliyor ise marker daha belirgin olabilir.
                if (item.durum === 'mudahale') {
                    // MÃ¼dahale ediliyor ise, Ã¶ncelik rengini korurken kenarlÄ±ÄŸÄ±nÄ± veya ikonunu deÄŸiÅŸtirebiliriz.
                    // Åimdilik sadece ana rengi Ã¶ncelik belirlesin.
                } else if (item.durum === 'kurtarildi') {
                    markerColor = '#047857'; // KurtarÄ±ldÄ±ysa koyu yeÅŸil
                }


                const customIcon = L.divIcon({
                    html: `<div style="background-color: ${markerColor}; width: 30px; height: 30px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-location-dot" style="color:white; font-size:16px;"></i></div>`,
                    iconSize: [30, 30],
                    className: 'custom-map-marker',
                    iconAnchor: [15, 30] 
                });

                const marker = L.marker([item.konum.lat, item.konum.lng], { icon: customIcon })
                                .bindPopup(`
                                    <b>ID: ${item.id}</b><br>
                                    Adres: ${item.konum.adres}<br>
                                    Durum: ${getStatusText(item.durum)}<br>
                                    Ã–ncelik: ${getPriorityText(item.oncelik)}<br>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${item.konum.lat},${item.konum.lng}" target="_blank">Yol Tarifi Al</a>
                                `);
                mainMapMarkers.addLayer(marker); // Markeri featureGroup'a ekle
                bounds.extend([item.konum.lat, item.konum.lng]); // SÄ±nÄ±rlarÄ± gÃ¼ncelle
            });

            if (bounds.isValid()) { // EÄŸer haritada marker varsa, hepsini kapsayacak ÅŸekilde haritayÄ± ayarla
                mainMap.fitBounds(bounds.pad(0.1)); // %10 boÅŸluk bÄ±rakarak fit et
            } else { // HiÃ§ marker yoksa TÃ¼rkiye'ye odaklan
                mainMap.setView([39.9334, 32.8597], 7);
            }
        }

        // Konum bilgisine tÄ±klandÄ±ÄŸÄ±nda haritayÄ± o konuma odakla
        function focusMapOnLocation(lat, lng, id) {
            if (mainMap) {
                mainMap.flyTo([lat, lng], 15); // Belirli bir zoom seviyesine uÃ§
                // TÄ±klanan markerÄ±n pop-up'Ä±nÄ± aÃ§ (opsiyonel, tÃ¼m markerlar zaten popup'lÄ±)
                mainMapMarkers.eachLayer(function(marker) {
                    if (marker.getLatLng().lat.toFixed(6) == lat.toFixed(6) && marker.getLatLng().lng.toFixed(6) == lng.toFixed(6)) {
                        marker.openPopup();
                    } else {
                        marker.closePopup(); // DiÄŸer pop-uplarÄ± kapat
                    }
                });
            }
        }

        // Veri render
        function renderData() {
            if (!mockData || mockData.length === 0) {
                dataCards.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                dataCards.style.display = 'block';
                emptyState.style.display = 'none';
            }

            const sortedData = [...mockData].sort((a, b) => {
                const priorityA = getPriorityOrder(a.oncelik);
                const priorityB = getPriorityOrder(b.oncelik);
                
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                
                return new Date(a.tarih) - new Date(b.tarih);
            });

            dataCards.innerHTML = sortedData.map(item => `
                <div class="data-card priority-${item.oncelik}" data-id="${item.id}">
                    <div class="card-header">
                        <div class="card-id">${item.id}</div>
                        <div class="priority-badge priority-${item.oncelik}">
                            ${getPriorityText(item.oncelik)}
                            <i class="fa-solid fa-robot ai-icon" title="Yapay Zeka tarafÄ±ndan Ã¶nceliklendirildi"></i>
                        </div>
                    </div>

                    <div class="location-info">
                        <div class="info-label">ğŸ“ Konum</div>
                        <div class="info-value clickable" onclick="focusMapOnLocation(${item.konum.lat}, ${item.konum.lng}, '${item.id}')">${item.konum.adres}</div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">
                            ${item.konum.lat.toFixed(6)}, ${item.konum.lng.toFixed(6)}
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${item.konum.lat},${item.konum.lng}" target="_blank" class="text-blue-600 hover:underline ml-2">
                                <i class="fa-solid fa-route"></i> Yol Tarifi
                            </a>
                        </div>
                    </div>

                    <div class="card-info">
                        <div class="info-item">
                            <div class="info-label">â° Gelen Veri Tarihi</div>
                            <div class="info-value">${formatDate(item.tarih)}</div>
                        </div>
                    </div>

                    ${item.detay ? `
                        <div class="info-item" style="margin-bottom: 15px;">
                            <div class="info-label">â„¹ï¸ Detay</div>
                            <div class="info-value">${item.detay}</div>
                        </div>
                    ` : ''}

                    <div class="current-status">
                        <div class="status-indicator status-${item.durum}"></div>
                        <div class="status-text">${getStatusText(item.durum)}</div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-bekleniyor" 
                                onclick="updateStatus('${item.id}', 'bekleniyor')"
                                ${item.durum === 'bekleniyor' ? 'disabled' : ''}>
                            â³ Bekliyor
                        </button>
                        <button class="btn btn-mudahale" 
                                onclick="updateStatus('${item.id}', 'mudahale')"
                                ${item.durum === 'mudahale' ? 'disabled' : ''}>
                            ğŸš‘ MÃ¼dahale
                        </button>
                        <button class="btn btn-kurtarildi" 
                                onclick="updateStatus('${item.id}', 'kurtarildi')"
                                ${item.durum === 'kurtarildi' ? 'disabled' : ''}>
                            âœ… KurtarÄ±ldÄ±
                        </button>
                    </div>
                    
                    <div class="timestamp">
                        Son gÃ¼ncelleme: ${formatTime(item.tarih)}
                    </div>
                </div>
            `).join('');

            // Ana haritayÄ± taleplerle gÃ¼ncelle
            updateMainMapMarkers();

            lastUpdate.textContent = new Date().toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function calculateDataHash(data) {
            return JSON.stringify(data.map(item => item.id).sort());
        }

        async function fetchData() {
            refreshBtn.classList.add('loading');
            
            try {
                const response = await fetch('/api/veriler');
                if (response.status === 401) { 
                    window.location.href = '/login.html'; 
                    return;
                }
                const data = await response.json();
                
                const newDataHash = calculateDataHash(data);
                
                if (lastDataHash && lastDataHash !== newDataHash) {
                    const oldIds = JSON.parse(lastDataHash);
                    const newIds = JSON.parse(newDataHash);
                    if (newIds.length > oldIds.length) {
                        showNotification('ğŸ”” Yeni arama kurtarma ilanÄ± geldi!');
                    }
                }
                
                lastDataHash = newDataHash;
                mockData = data;
                
                updateConnectionStatus(true);
                renderData(); // Hem kartlarÄ± hem haritayÄ± gÃ¼ncelleyecek
                
            } catch (error) {
                console.error('Veri Ã§ekilirken hata:', error);
                updateConnectionStatus(false);
                showNotification('Veri Ã§ekilirken hata oluÅŸtu: ' + error.message, true);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMainMap(); // Sayfa yÃ¼klenince ana haritayÄ± baÅŸlat
            fetchData();
            
            setInterval(fetchData, 3000);
        });

        window.addEventListener('online', () => {
            updateConnectionStatus(true);
            fetchData();
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus(false);
        });
        
        // Window resize olduÄŸunda haritanÄ±n boyutunu gÃ¼ncelle
        window.addEventListener('resize', function() {
            if (mainMap) {
                mainMap.invalidateSize();
                // HaritanÄ±n ortalanmasÄ± iÃ§in uygun koÅŸullar altÄ±nda updateMainMapMarkers Ã§aÄŸrÄ±lmalÄ±
                // Sadece boyut deÄŸiÅŸince deÄŸil, harita iÃ§eriÄŸi de deÄŸiÅŸince iyi olabilir.
                // Burada her resize'da tÃ¼m markerlarÄ± yenilemek yerine sadece ortalamayÄ± tetikleyebiliriz.
                // Åimdilik bu kÄ±smÄ± kaldÄ±rÄ±yorum ki sÃ¼rekli gereksiz yeniden render olmasÄ±n,
                // fitBounds zaten updateMainMapMarkers iÃ§inde yapÄ±lÄ±yor.
                // EÄŸer harita boÅŸsa, fitBounds bir hata verebilir, onu da handle etmek iyi olur.
            }
        });
    </script>
</body>
</html>